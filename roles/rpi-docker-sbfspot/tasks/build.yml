---
- name: copy dockerfiles Base Image 
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: pi
    mode: 0755
  with_items:
    - { src: 'build/Dockerfile', dest: '~/sbfspot-build/'}
  tags:
    - build

- name: build docker Base Image
  docker_image:
    path: ~/sbfspot-build
    name: sbfspot
    state: present 
    debug: yes
  tags:
    - build
- name: copy Dockerfiles for spbfspot-collector
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: pi
    mode: 0755
  with_items:
    - { src: 'collector/Dockerfile', dest: '~/sbfspot-col-build/'}
    - { src: 'collector/SBFspot.sh', dest: '~/sbfspot-col-build/'}
  tags:
    - build

- name: build docker image spbfspot-col
  docker_image:
    path: ~/sbfspot-col-build
    name: sbfspot-col
    pull: no
    state: present 
    debug: yes
  tags:
    - build

- name: copy Dockerfiles for spbfspot-collector
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: pi
    mode: 0755
  with_items:
    - { src: 'uploader/Dockerfile', dest: '~/sbfspot-upl-build/'}
    - { src: 'uploader/SBFspotUploadDaemon.sh', dest: '~/sbfspot-upl-build/'}
  tags:
    - build

- name: build docker image spbfspot-col
  docker_image:
    path: ~/sbfspot-upl-build
    name: sbfspot-upl
    pull: no
    state: present
    debug: yes
  tags:
    - build

- name: copy sbfspot configfiles
  copy:
    src: "{{ item.src }}"
    dest: "{{ item.dest }}"
    owner: pi
    mode: 0755
  with_items:
    - { src: 'SBFspot.cfg', dest: '/data/sbfspot/config/'}
    - { src: 'SBFspotUpload.cfg', dest: '/data/sbfspot/config/'}
  tags:
    - build
    - run

- shell: "docker container stop sbfspot-collector"
  ignore_errors: yes
  tags:
    - run
- shell: "docker container rm sbfspot-collector"
  ignore_errors: yes
  tags:
    - run
- shell: "docker container stop sbfspot-uploader"
  ignore_errors: yes
  tags:
    - run
- shell: "docker container rm sbfspot-uploader"
  ignore_errors: yes
  tags:
    - run
- name: run container sbfspot-collector
  shell: " docker run -v /etc/localtime:/etc/localtime:ro -v /data/sbfspot:/var/smadata -v /data/sbfspot/config/SBFspot.cfg:/opt/sbfspot/SBFspot.cfg --net=host --privileged --name sbfspot-collector sbfspot-col"
  tags:
    - run

- name: Add to crontab
  cron:
    job: "docker start -a sbfspot-collector > /dev/null 2>&1"
    name: 'sbfspot-collector'
    minute: "*/5"
    hour:   "5-23"
    state: present
  tags:
    - run

- name: run container sbfspot-uploader
  shell: "docker run -dt -v /etc/localtime:/etc/localtime:ro -v /data/sbfspot:/var/smadata -v /data/sbfspot/config/SBFspotUpload.cfg:/opt/sbfspot/SBFspotUpload.cfg --name sbfspot-uploader sbfspot-upl"
  tags:
    - run

#- name: create nfs mount
#  shell: docker volume create --driver local --opt type=nfs --opt o=addr=10.10.10.60,rw --opt device=:/Recordings nfscam
#- name: Docker Run container
#  shell: docker run -d --name=rpi-cam -p=80:80/tcp --mount source=nfscam,destination=/data --device=/dev/vchiq --device=/dev/vcsm rpi-cam-web --restart always
